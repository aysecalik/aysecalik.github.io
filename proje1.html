import numpy as np
import pandas as pd
from sklearn.impute import KNNImputer
from sklearn.model_selection import train_test_split
from sklearn.tree import DecisionTreeRegressor
from sklearn.tree import DecisionTreeClassifier
from sklearn.preprocessing import MinMaxScaler 
from graphviz import Source
from sklearn import metrics 
import matplotlib.pyplot as plt 
from sklearn.metrics import accuracy_score
from sklearn.metrics import classification_report, confusion_matrix

from sklearn.linear_model import LogisticRegression
from sklearn.impute import KNNImputer

from sklearn.model_selection import train_test_split

from sklearn.tree import export_graphviz
import graphviz

# Excel dosyasının yolunu belirtin
data= ("C:\\Users\\HP\\Desktop\\ist405_arasinav_data1.xls")

# Excel dosyasını pandas ile yükleme
data = pd.read_excel(data)


data.info()
data.dtypes
print(data.shape)
print(data.describe()) # Sayısal sütunların istatistiksel özeti

row, col = data.shape
print(row)
print(col)
print(data.size) 

list(data.columns) 

   
# Kategorik degiskenlerin veri tipinin category yapilmasi
data.dtypes

data["cinsiyet"] = data["cinsiyet"].astype("category")
data["egitimduzeyi"] = data["egitimduzeyi"].astype("category")
data["meslegi"] = data["meslegi"].astype("category")
data["sigarakullanimi"] = data["sigarakullanimi"].astype("category")
data["hastaneyeyattimi"] = data["hastaneyeyattimi"].astype("category")
data["ailedekoahveyaastimTaniliHastavarmi"] = data["ailedekoahveyaastimTaniliHastavarmi"].astype("category")
data["varsakimde_ANNE"] = data["varsakimde_ANNE"].astype("category")
data["varsakimde_BABA"] = data["varsakimde_BABA"].astype("category")
data["varsakimde_KARDES"] = data["varsakimde_KARDES"].astype("category")
data["varsakimde_DIGER"] = data["varsakimde_DIGER"].astype("category")

######################################################################################################

################################# VERİ ÖNİŞLEME ######################################
#SÜTUN ÇIKARMA
data = data.drop(columns=['acilservistoplamyatıssuresigun'])
data = data.drop(columns=['yogunbakimatoplamyatissuresigun'])
data = data.drop(columns=['servisetoplamyatissüresigun'])
data = data.drop(columns=['basvurutarihi'])
#SİGARA KULLANIMI DEĞİŞKENLERİNİ 0 İLE DOLDURMA
deger = 0
data.loc[(data["sigarakullanimi"] == 1) & (data["sigarayibirakannekadarGUNicmis"].isna()), "sigarayibirakannekadarGUNicmis"] = deger
data.loc[(data["sigarakullanimi"] == 3) & (data["sigarayibirakannekadarGUNicmis"].isna()), "sigarayibirakannekadarGUNicmis"] = deger

deger=0
data.loc[(data["sigarakullanimi"]== 1)&(data["sigarabirakangundekacadeticmis"].isna()),"sigarabirakangundekacadeticmis"]=deger
data.loc[(data["sigarakullanimi"]== 3)&(data["sigarabirakangundekacadeticmis"].isna()),"sigarabirakangundekacadeticmis"]=deger

deger=0
data.loc[(data["sigarakullanimi"]== 1)&(data["nezamanbirakmisGUN"].isna()),"nezamanbirakmisGUN"]=deger
data.loc[(data["sigarakullanimi"]== 3)&(data["nezamanbirakmisGUN"].isna()),"nezamanbirakmisGUN"]=deger

deger = 0
data.loc[(data["sigarakullanimi"] == 1) & (data["sigarayadevamedengundekacadeticiyo"].isna()), "sigarayadevamedengundekacadeticiyo"] = deger
data.loc[(data["sigarakullanimi"] == 2) & (data["sigarayadevamedengundekacadeticiyo"].isna()), "sigarayadevamedengundekacadeticiyo"] = deger

#BOŞLUKLARI EN YAKIN KOMŞU İLE DOLDURMA
# En yakın komşu metodu ile boş gözlemlerin doldurulması
# Sadece sayısal değişkenleri seçme
numeric_data = data.select_dtypes(include=['float64', 'int64'])

# KNNImputer kullanarak eksik değerleri doldurma
imputer = KNNImputer(n_neighbors=2)  # Komşu sayısını belirleyin
numeric_data_filled = pd.DataFrame(imputer.fit_transform(numeric_data), columns=numeric_data.columns)

# Doldurulan sayısal veriyi orijinal veri setine geri ekleme
data[numeric_data.columns] = numeric_data_filled

print("\nEksik değerleri doldurulmuş veri seti:")
print(data)

# veri kümesi (DataFrame formatında)

data = pd.DataFrame(data)

print("Eksik değerler içeren veri kümesi:")
print(data)

# KNN Imputer tanımlama (komşu sayısı 2 olarak seçildi)
imputer = KNNImputer(n_neighbors=4)

# Eksik değerleri doldurma
new_data = imputer.fit_transform(data)

# Yeniden DataFrame'e dönüştürerek sütun adlarını koruma
new_data = pd.DataFrame(new_data, columns=data.columns)

print("\nEksik değerleri doldurulmuş veri kümesi:")
print(new_data)


#k=4 alındığında varsakimde na 287 ve 303 olan kişiler 0.5'ten küçük değerler 0, 0.5'ten büyük değerler 1 olarak varsayıp phyton üzerinde düzenlenlendi.


#BOX-PLOT AYKIRI DEĞER
#aykırı değer box-plot
import seaborn as sns
import matplotlib.pyplot as plt


# Sadece sayısal sütunları seçmek
sayisal_veriler = new_data.select_dtypes(include=["float64", "int64"])

# Sayısal değişkenler için yatay box plot
plt.figure(figsize=(12, len(sayisal_veriler.columns) * 0.5))  # Boyutları ayarla

sns.boxplot(data=sayisal_veriler, orient="h", palette="Set3")  # Yatay box plot

# Başlık ve eksen etiketleri
plt.title("Box Plot - Sadece Sayısal Değişkenler", fontsize=16)
plt.xlabel("Değerler", fontsize=12)
plt.ylabel("Değişkenler", fontsize=12)

plt.grid(axis="x", linestyle="--", alpha=0.7)  # X eksenine grid ekle

plt.show()



# FEV1 değişkenindeki aykırı değerleri tespit etme (IQR yöntemi)
Q1 = new_data["FEV1"].quantile(0.25)  # İlk çeyrek (Q1)
Q3 = new_data["FEV1"].quantile(0.75)  # Üçüncü çeyrek (Q3)
IQR = Q3 - Q1                        # IQR hesaplama
alt_sinir = Q1 - 1.5 * IQR           # Alt sınır
ust_sinir = Q3 + 1.5 * IQR           # Üst sınır

# Aykırı değerlerin tespiti
aykiri_degerler = new_data[(new_data["FEV1"] < alt_sinir) | (new_data["FEV1"] > ust_sinir)]

# 2. Box plot ile aykırı değerleri görselleştirelim
plt.figure(figsize=(8, 4))
sns.boxplot(x=new_data["FEV1"], palette="colorblind")

#başlık ve etiketler
plt.title("Box Plot - FEV1 Değişkeni ve Aykırı Değerlerin Gözlem Numaraları", fontsize=16)
plt.xlabel("FEV1 Değerleri", fontsize=12)

# Grafiği göster
plt.show()

# YAŞ değişkenindeki aykırı değerleri tespit etme (IQR yöntemi)
Q1 = new_data["YAS"].quantile(0.25)  # İlk çeyrek (Q1)
Q3 = new_data["YAS"].quantile(0.75)  # Üçüncü çeyrek (Q3)
IQR = Q3 - Q1                        # IQR hesaplama
alt_sinir = Q1 - 1.5 * IQR           # Alt sınır
ust_sinir = Q3 + 1.5 * IQR           # Üst sınır

# Aykırı değerlerin tespiti
aykiri_degerler = new_data[(new_data["YAS"] < alt_sinir) | (new_data["YAS"] > ust_sinir)]

# 2. Box plot ile aykırı değerleri görselleştirelim
plt.figure(figsize=(8, 4))
sns.boxplot(x=new_data["YAS"], palette="colorblind")

# Başlık ve etiketler
plt.title("Box Plot - YAŞ Değişkeni ve Aykırı Değerlerin Gözlem Numaraları", fontsize=16)
plt.xlabel("YAŞ Değerleri", fontsize=12)

# Grafiği göster
plt.show()



filtered_data = new_data[new_data["sigarakullanimi"] == 2]["sigarayibirakannekadarGUNicmis"]
print(filtered_data)


plt.figure(figsize=(8, 6))
plt.boxplot(filtered_data, vert=False, patch_artist=True,labels=["Sigara Bırakanlar"])
plt.title("Sigarayı Bırakan Kişiler Ne Kadar Gün İçmiş", fontsize=14)
plt.xlabel("Gün Sayısı", fontsize=12)
plt.show()

#KAÇ ADET İÇMİŞ
filtered_data1 = new_data[new_data["sigarakullanimi"] == 2]["sigarabirakangundekacadeticmis"]
print(filtered_data1)


plt.figure(figsize=(8, 6))
plt.boxplot(filtered_data1, vert=False, patch_artist=True,labels=["Sigara Bırakanlar"])
plt.title("Sigarayı Bırakan Kişiler Günde Kaç Adet İçmiş", fontsize=14)
plt.xlabel("Sigara Günlük Adet Sayısı", fontsize=12)
plt.show()

#NE ZAMAN BIRAKMIŞ GÜN
filtered_data2 = new_data[new_data["sigarakullanimi"] == 2]["nezamanbirakmisGUN"]
print(filtered_data2)


plt.figure(figsize=(8, 6))
plt.boxplot(filtered_data2, vert=False, patch_artist=True,labels=["Sigara Bırakanlar"])
plt.title("Sigarayı Bırakan Kişiler Ne Zaman Bırakmış", fontsize=14)
plt.xlabel("Gün Sayısı", fontsize=12)
plt.show()

#SİGARAYA DEVAM EDEN GÜNDE KAÇ ADET İÇİYO
filtered_data3 = new_data[new_data["sigarakullanimi"] == 3]["sigarayadevamedengundekacadeticiyo"]
print(filtered_data3)


plt.figure(figsize=(8, 6))
plt.boxplot(filtered_data3, vert=False, patch_artist=True,labels=["Sigaraya Devam Eden Kişiler"])
plt.title("Sigaraya Devam Eden Kişiler Günde Kaç Adet İçiyor", fontsize=14)
plt.xlabel("Günlük İçilen Sigara Sayısı", fontsize=12)
plt.show()

# tanisuresiay değişkenindeki aykırı değerleri tespit etme (IQR yöntemi)
Q1 = new_data["tanisuresiay"].quantile(0.25)  # İlk çeyrek (Q1)
Q3 = new_data["tanisuresiay"].quantile(0.75)  # Üçüncü çeyrek (Q3)
IQR = Q3 - Q1                        # IQR hesaplama
alt_sinir = Q1 - 1.5 * IQR           # Alt sınır
ust_sinir = Q3 + 1.5 * IQR           # Üst sınır

# Aykırı değerlerin tespiti
aykiri_degerler = new_data[(new_data["tanisuresiay"] < alt_sinir) | (new_data["tanisuresiay"] > ust_sinir)]

# 2. Box plot ile aykırı değerleri görselleştirelim
plt.figure(figsize=(8, 4))
sns.boxplot(x=new_data["tanisuresiay"], palette="colorblind")

# Başlık ve etiketler
plt.title("Box Plot - Tanı Suresi Ay Değişkeni ve Aykırı Değerlerin Gözlem Numaraları", fontsize=16)
plt.xlabel("Tanı Suresi (Ay) Değerleri", fontsize=12)

# Grafiği göster
plt.show()

# acilserviseyatissayisi değişkenindeki aykırı değerleri tespit etme (IQR yöntemi)
Q1 = new_data["acilserviseyatissayisi"].quantile(0.25)  # İlk çeyrek (Q1)
Q3 = new_data["acilserviseyatissayisi"].quantile(0.75)  # Üçüncü çeyrek (Q3)
IQR = Q3 - Q1                        # IQR hesaplama
alt_sinir = Q1 - 1.5 * IQR           # Alt sınır
ust_sinir = Q3 + 1.5 * IQR           # Üst sınır

# Aykırı değerlerin tespiti
aykiri_degerler = new_data[(new_data["acilserviseyatissayisi"] < alt_sinir) | (new_data["acilserviseyatissayisi"] > ust_sinir)]

# 2. Box plot ile aykırı değerleri görselleştirelim
plt.figure(figsize=(8, 4))
sns.boxplot(x=new_data["acilserviseyatissayisi"], palette="colorblind")

# Başlık ve etiketler
plt.title("Box Plot - acilserviseyatissayisi ve Aykırı Değerlerin Gözlem Numaraları", fontsize=16)
plt.xlabel("Acil Servise Yatis Sayisi Değerleri", fontsize=12)

# Grafiği göster
plt.show()

# boy değişkenindeki aykırı değerleri tespit etme (IQR yöntemi)
Q1 = new_data["boy"].quantile(0.25)  # İlk çeyrek (Q1)
Q3 = new_data["boy"].quantile(0.75)  # Üçüncü çeyrek (Q3)
IQR = Q3 - Q1                        # IQR hesaplama
alt_sinir = Q1 - 1.5 * IQR           # Alt sınır
ust_sinir = Q3 + 1.5 * IQR           # Üst sınır

# Aykırı değerlerin tespiti
aykiri_degerler = new_data[(new_data["boy"] < alt_sinir) | (new_data["boy"] > ust_sinir)]

# 2. Box plot ile aykırı değerleri görselleştirelim
plt.figure(figsize=(10, 4))
sns.boxplot(x=new_data["boy"], palette="colorblind")

# Başlık ve etiketler
plt.title("Box Plot - boy Aykırı Değerlerin Gözlem Numaraları", fontsize=16)
plt.xlabel("boy Değerleri", fontsize=12)

# Grafiği göster
plt.show()

#vucutagirligi değişkenindeki aykırı değerleri tespit etme (IQR yöntemi)
Q1 = new_data["vucutagirligi"].quantile(0.25)  # İlk çeyrek (Q1)
Q3 = new_data["vucutagirligi"].quantile(0.75)  # Üçüncü çeyrek (Q3)
IQR = Q3 - Q1                        # IQR hesaplama
alt_sinir = Q1 - 1.5 * IQR           # Alt sınır
ust_sinir = Q3 + 1.5 * IQR           # Üst sınır

# Aykırı değerlerin tespiti
aykiri_degerler = new_data[(new_data["vucutagirligi"] < alt_sinir) | (new_data["vucutagirligi"] > ust_sinir)]

# 2. Box plot ile aykırı değerleri görselleştirelim
plt.figure(figsize=(10, 4))
sns.boxplot(x=new_data["vucutagirligi"], palette="colorblind")

# Başlık ve etiketler
plt.title("Box Plot - vucutagirligi Aykırı Değerlerin Gözlem Numaraları", fontsize=16)
plt.xlabel("Vücut Ağırlığı Değerleri", fontsize=12)

# Grafiği göster
plt.show()

#kanbasincisistolik değişkenindeki aykırı değerleri tespit etme (IQR yöntemi)
Q1 = new_data["kanbasincisistolik"].quantile(0.25)  # İlk çeyrek (Q1)
Q3 = new_data["kanbasincisistolik"].quantile(0.75)  # Üçüncü çeyrek (Q3)
IQR = Q3 - Q1                        # IQR hesaplama
alt_sinir = Q1 - 1.5 * IQR           # Alt sınır
ust_sinir = Q3 + 1.5 * IQR           # Üst sınır

# Aykırı değerlerin tespiti
aykiri_degerler = new_data[(new_data["kanbasincisistolik"] < alt_sinir) | (new_data["kanbasincisistolik"] > ust_sinir)]

# 2. Box plot ile aykırı değerleri görselleştirelim
plt.figure(figsize=(10, 4))
sns.boxplot(x=new_data["kanbasincisistolik"], palette="colorblind")

# Başlık ve etiketler
plt.title("Box Plot - kanbasincisistolik Aykırı Değerlerin Gözlem Numaraları", fontsize=16)
plt.xlabel("Kan Basıncı Sistolik Değerleri", fontsize=12)

# Grafiği göster
plt.show()


# kanbasincidiastolik değişkenindeki aykırı değerleri tespit etme (IQR yöntemi)
Q1 = new_data["kanbasincidiastolik"].quantile(0.25)  # İlk çeyrek (Q1)
Q3 = new_data["kanbasincidiastolik"].quantile(0.75)  # Üçüncü çeyrek (Q3)
IQR = Q3 - Q1                        # IQR hesaplama
alt_sinir = Q1 - 1.5 * IQR           # Alt sınır
ust_sinir = Q3 + 1.5 * IQR           # Üst sınır

# Aykırı değerlerin tespiti
aykiri_degerler = new_data[(new_data["kanbasincidiastolik"] < alt_sinir) | (new_data["kanbasincidiastolik"] > ust_sinir)]

# 2. Box plot ile aykırı değerleri görselleştirelim
plt.figure(figsize=(10, 4))
sns.boxplot(x=new_data["nabiz"], palette="colorblind")

# Başlık ve etiketler
plt.title("Box Plot - kanbasincidiastolik ve Aykırı Değerlerin Gözlem Numaraları", fontsize=16)
plt.xlabel("Kan Basıncı Diastolik Değeri", fontsize=12)

# Grafiği göster
plt.show()

# nabiz değişkenindeki aykırı değerleri tespit etme (IQR yöntemi)
Q1 = new_data["nabiz"].quantile(0.25)  # İlk çeyrek (Q1)
Q3 = new_data["nabiz"].quantile(0.75)  # Üçüncü çeyrek (Q3)
IQR = Q3 - Q1                        # IQR hesaplama
alt_sinir = Q1 - 1.5 * IQR           # Alt sınır
ust_sinir = Q3 + 1.5 * IQR           # Üst sınır

# Aykırı değerlerin tespiti
aykiri_degerler = new_data[(new_data["nabiz"] < alt_sinir) | (new_data["nabiz"] > ust_sinir)]

# 2. Box plot ile aykırı değerleri görselleştirelim
plt.figure(figsize=(10, 4))
sns.boxplot(x=new_data["nabiz"], palette="colorblind")
# Başlık ve etiketler
plt.title("Box Plot - nabiz Aykırı Değerlerin Gözlem Numaraları", fontsize=16)
plt.xlabel("Nabız Değeri", fontsize=12)

# Grafiği göster
plt.show()

# solunumsayisi değişkenindeki aykırı değerleri tespit etme (IQR yöntemi)
Q1 = new_data["solunumsayisi"].quantile(0.25)  # İlk çeyrek (Q1)
Q3 = new_data["solunumsayisi"].quantile(0.75)  # Üçüncü çeyrek (Q3)
IQR = Q3 - Q1                        # IQR hesaplama
alt_sinir = Q1 - 1.5 * IQR           # Alt sınır
ust_sinir = Q3 + 1.5 * IQR           # Üst sınır

# Aykırı değerlerin tespiti
aykiri_degerler = new_data[(new_data["solunumsayisi"] < alt_sinir) | (new_data["solunumsayisi"] > ust_sinir)]

# 2. Box plot ile aykırı değerleri görselleştirelim
plt.figure(figsize=(10, 4))
sns.boxplot(x=new_data["solunumsayisi"], palette="colorblind")

# Başlık ve etiketler
plt.title("Box Plot - solunumsayisi Aykırı Değerlerin Gözlem Numaraları", fontsize=16)
plt.xlabel("Solunum Sayısı Değeri", fontsize=12)

# Grafiği göster
plt.show()

# TEK DEĞİŞKENLİ VE ÇOK DEĞİŞKENLİ YAKLAŞIMLAR-TANIMLAYICI İSTATİSTİKLER- KOVARYANS KORELASYON K-MEANS
#TEK DEĞİŞKENLİ YAKLAŞIM -TANIMLAYICI İSTATİSTİKLER
new_data.describe()  # sadece sayisal degiskenlerin istatistikleri
pd.set_option('display.max_columns', None)

new_data.describe(include="all") ### include="float64"
new_data.isnull().any()
new_data.isnull().sum()

#ÇOK DEĞİŞKENLİ YAKLAŞIMLAR
#korelasyon
korelasyon = new_data.corr()
print(korelasyon)
plt.figure(figsize=(10, 10)) 
sns.heatmap(korelasyon, annot=False, cmap='RdBu', fmt='.2f', linewidths=0.5)
plt.title('KORELASYON MATRİSİ', fontsize=16)
plt.show()

#kovaryans
kovaryans = new_data.cov()
print(kovaryans)

plt.figure(figsize=(10, 10)) 
sns.heatmap(korelasyon, annot=False, cmap='PiYG', fmt='.2f', linewidths=0.5)
plt.title('KOVARYANS MATRİSİ', fontsize=16)
plt.show()

#KÜMELEME
from sklearn.cluster import KMeans
import matplotlib.pyplot as plt

# Dirsek Yöntemi ile küme sayısı belirleme
numeric_data = new_data.select_dtypes(include=['float64', 'int64'])
inertia = []
for k in range(1, 10):  # 1'den 9'a kadar küme sayısını deniyoruz
    kmeans = KMeans(n_clusters=k, n_init=10, random_state=42)
    kmeans.fit(numeric_data)
    inertia.append(kmeans.inertia_)

plt.figure(figsize=(8, 6))
plt.plot(range(1, 10), inertia, marker='o', linestyle='-', color='b')
plt.title("Dirsek Yöntemi ile Optimal Küme Sayısı")
plt.xlabel("Küme Sayısı")
plt.ylabel("Inertia (Hata Kareler Toplamı)")
plt.grid(True)
plt.show()

#veri kümesi için dirsek noktası olan 3 optimal küme sayısını gösterir.
#k-means kümeleme
kmeans = KMeans(n_clusters=3) #3 küme belirtir.
#Küme 0: Nabzı düşük ve kan basıncı düşük olan bireyler.
#Küme 1: Nabzı orta seviyede ve kan basıncı orta seviyede olan bireyler.
#Küme 2: Nabzı yüksek ve kan basıncı yüksek olan bireyler.

#nabiz ve sistolik kan basıncı için k-means
kmeans.fit(new_data[['nabiz', 'kanbasincisistolik']])
labels = kmeans.labels_
centroids = kmeans.cluster_centers_#merkez koordinatlar
new_data['Küme'] = labels
print(data)
# Küme merkezlerini çizme
plt.scatter(new_data['nabiz'], new_data['kanbasincisistolik'], c=new_data['Küme'], cmap='Dark2')
plt.scatter(centroids[:, 0], centroids[:, 1], s=300, c='black', marker='X')  # Küme merkezleri
plt.title("K-means Kümeleme Sonuçları")
plt.xlabel("Nabız")
plt.ylabel("Kan Basıncı (Sistolik)")
plt.show()

#yas ve fev(FEV, bir kişinin derin bir nefes aldıktan sonra, zorlayarak üflediği havanın hacmini ölçer.) için k-means
kmeans = KMeans(n_clusters=3, random_state=42)
kmeans.fit(new_data[['YAS', 'FEV1']])  # YAŞ ve FEV1 değişkenlerini kullanarak fit et
new_data['Küme'] = kmeans.labels_
centroids = kmeans.cluster_centers_ # Küme merkezleri
# Grafik çizimi
plt.figure(figsize=(10, 7))
plt.scatter(new_data['YAS'], new_data['FEV1'], c=new_data['Küme'], cmap='flag')  # Küme etiketlerine göre renkli scatter
plt.scatter(centroids[:, 0], centroids[:, 1], s=300, c='gray', marker='X', label='Küme Merkezleri')  # Küme merkezlerini göster
plt.title("K-means Kümeleme Sonuçları")
plt.xlabel("YAŞ")
plt.ylabel("FEV1")
plt.legend()
plt.show()

#solunum say vcüut agırlığı için k-means
kmeans = KMeans(n_clusters=3, random_state=42)
kmeans.fit(new_data[['vucutagirligi', 'solunumsayisi']])  # YAŞ ve FEV1 değişkenlerini kullanarak fit et
new_data['Küme'] = kmeans.labels_
centroids = kmeans.cluster_centers_ # Küme merkezleri
# Grafik çizimi
plt.figure(figsize=(10, 7))
plt.scatter(new_data['vucutagirligi'], new_data['solunumsayisi'], c=new_data['Küme'], cmap='crest')  # Küme etiketlerine göre renkli scatter
plt.scatter(centroids[:, 0], centroids[:, 1], s=300, c='black', marker='X', label='Küme Merkezleri')  # Küme merkezlerini göster
plt.title("K-means Kümeleme Sonuçları")
plt.xlabel("VÜCUT AĞIRLIĞI")
plt.ylabel("SOLUNUM SAYISI")
plt.legend()
plt.show()

########################################## VERİ GÖRSELLEŞTİRME #####################################
import seaborn as sns
import matplotlib.pyplot as plt

#histogram grafikleri

plt.hist(new_data['YAS'], bins=50, align='right', color='purple', edgecolor='red')
plt.xlabel('YAŞ değeri')
plt.ylabel('sıklık')
plt.title('YAŞ dağılımı')

plt.hist(new_data['kanbasincisistolik'], bins=40, align='right', color='lightblue', edgecolor='navy')
plt.xlabel('Kan Basıncındaki Sistolik Değer')
plt.ylabel('Sıklık')
plt.title('Kan Basıncındaki Sistolik Değer Dağılımı')

plt.hist(new_data['nabiz'], bins=60, align='right', color='pink', edgecolor='magenta')
plt.xlabel('Nabız Değeri')
plt.ylabel('Sıklık')
plt.title('Nabız Değer Dağılımı')

##################################### İKİ DEĞİŞKEN İÇİN İLİŞKİLİ KUTU GRAFİĞİ ##################################

##################################################################
filtered_data2 = new_data[new_data["sigarakullanimi"] == 2]
# Box plot oluşturma
plt.figure(figsize=(8, 6))
sns.boxplot(data=filtered_data2, x="meslegi", y="sigarayibirakannekadarGUNicmis", palette="muted")

category_info = {
    1: "İşsiz",
    2: "Emekli",
    3: "Memur",
    4: "İşçi",
    5: "Özel Sektör",
    6: "Serbest"
}
handles = [plt.Line2D([0], [0], color=color, lw=4) for color in sns.color_palette("muted", n_colors=len(category_info))]
labels = list(category_info.values())
plt.legend(handles, labels, title="Mesleği", bbox_to_anchor=(1.05, 1), loc='upper left')

plt.tight_layout()
plt.show()


#**************************diğer kategorikler için aynı grafiği çizdirme*************************************
import seaborn as sns
import matplotlib.pyplot as plt
# Box plot oluşturma
plt.figure(figsize=(8, 6))
sns.boxplot(data=filtered_data2, x="egitimduzeyi", y="sigarayibirakannekadarGUNicmis", palette="Pastel1")

category_info = {
    1: "Yüksekokul",
    2: "Lise",
    3: "İlkokul",
    4: "Okur-Yazar",
    5: "Okur-Yazar Olmayan"
}
handles = [plt.Line2D([0], [0], color=color, lw=4) for color in sns.color_palette("Pastel1", n_colors=len(category_info))]
labels = list(category_info.values())
plt.legend(handles, labels, title="Eğitim Düzeyleri", bbox_to_anchor=(1.05, 1), loc='upper left')

plt.tight_layout()
plt.show()


#************************violin*************************
plt.figure(figsize=(10, 6))
sns.violinplot(data=filtered_data2, x="egitimduzeyi", y="sigarayibirakannekadarGUNicmis", palette="Pastel1")
# Grafik başlık ve eksen etiketleri
plt.title("Sigara Kullanımı (2) ve Eğitim Düzeyi", fontsize=16)
plt.xlabel("Eğitim Düzeyi", fontsize=12)
plt.ylabel("Sigara Bırakma Süresi (Gün Sayısı)", fontsize=12)

# Legend (açıklama kutusu)
category_info = {
    1: "Yüksekokul",
    2: "Lise",
    3: "İlkokul",
    4: "Okur-Yazar",
    5: "Okur-Yazar Olmayan"
}
handles = [plt.Line2D([0], [0], color=color, lw=4) for color in sns.color_palette("Pastel1", n_colors=len(category_info))]
labels = list(category_info.values())
plt.legend(handles, labels, title="Eğitim Düzeyleri", bbox_to_anchor=(1.05, 1), loc='upper left')

plt.tight_layout()
plt.show()




#*****************************************************************************************
import seaborn as sns
import matplotlib.pyplot as plt
# Box plot oluşturma
plt.figure(figsize=(8, 6))
sns.boxplot(data=filtered_data2, x="hastaneyeyattimi", y="sigarayibirakannekadarGUNicmis", palette="Set3")

# Grafik başlık ve etiketler
category_info = {
    1: "Evet",
    2: "Hayır",
}

handles = [plt.Line2D([0], [0], color=color, lw=4) for color in sns.color_palette("Set3", n_colors=len(category_info))]
labels = list(category_info.values())
plt.legend(handles, labels, title="Hastaneye yattı mı?", bbox_to_anchor=(1.05,1), loc='upper left')

plt.tight_layout()
plt.show()

#aynı değişkenler için violin***

sns.violinplot(data=filtered_data2, x="hastaneyeyattimi", y="sigarayibirakannekadarGUNicmis", palette="Pastel1")
category_info = {
    1: "Evet",
    2: "Hayır",
}

handles = [plt.Line2D([0], [0], color=color, lw=4) for color in sns.color_palette("Pastel1", n_colors=len(category_info))]
labels = list(category_info.values())
plt.legend(handles, labels, title="Hataneye yattı mı?", bbox_to_anchor=(1.05,1), loc='upper left')

plt.tight_layout()
plt.show()

#****************************************************************************
plt.figure(figsize=(16, 8))
sns.boxplot(data=new_data, x="meslegi", y="solunumsayisi", hue="sigarakullanimi", palette="Set2")

plt.title("Sigara Kullanımı, Meslek ve Solunum Sayısı Karşılaştırması", fontsize=16)

category_info = {
    1: "Hiç İçmemiş",
    2: "Bırakmış",
    3: "Halen İçiyor"
}
info_text = """
Meslekler:
1: İşsiz
2: Emekli
3: Memur
4: İşçi
5: Özel Sektör
6: Serbest
"""
plt.gcf().text(0.8, 0.5, info_text, fontsize=10, color="black", bbox=dict(facecolor="white", alpha=0.5))
handles = [plt.Line2D([0], [0], color=color, lw=4) for color in sns.color_palette("Pastel1", n_colors=len(category_info))]
labels = list(category_info.values())
plt.legend(handles, labels, title="Sigara Kullanımı", bbox_to_anchor=(1.05,1), loc='upper left')

plt.tight_layout()
plt.show()

######################################## MODEL KURMA ###############################################

#TEST VERİ KÜMESİ ÇEKME
new_datatest= ("C:\\Users\\HP\\Desktop\\new_datatest.xlsx")

# Excel dosyasını pandas ile yükleme
new_datatest = pd.read_excel(new_datatest)

new_datatest["cinsiyet"] = new_datatest["cinsiyet"].astype("category")
new_datatest["egitimduzeyi"] = new_datatest["egitimduzeyi"].astype("category")
new_datatest["meslegi"] = new_datatest["meslegi"].astype("category")
new_datatest["sigarakullanimi"] = new_datatest["sigarakullanimi"].astype("category")
new_datatest["hastaneyeyattimi"] = new_datatest["hastaneyeyattimi"].astype("category")
new_datatest["ailedekoahveyaastimTaniliHastavarmi"] = new_datatest["ailedekoahveyaastimTaniliHastavarmi"].astype("category")
new_datatest["varsakimde_ANNE"] = new_datatest["varsakimde_ANNE"].astype("category")
new_datatest["varsakimde_BABA"] = new_datatest["varsakimde_BABA"].astype("category")
new_datatest["varsakimde_KARDES"] = new_datatest["varsakimde_KARDES"].astype("category")
new_datatest["varsakimde_DIGER"] = new_datatest["varsakimde_DIGER"].astype("category")


#KATEGORİK VERİLER İÇİN BOŞLUKLARI DOLDURMA
new_datatest = pd.DataFrame(new_datatest)

print("Eksik değerler içeren veri kümesi:")
print(new_datatest)

# KNN Imputer tanımlama (komşu sayısı 2 olarak seçildi)
imputer = KNNImputer(n_neighbors=1)

# Eksik değerleri doldurma
data_test = imputer.fit_transform(new_datatest)

# Yeniden DataFrame'e dönüştürerek sütun adlarını koruma
data_test = pd.DataFrame(data_test, columns=new_datatest.columns)

print("\nEksik değerleri doldurulmuş veri kümesi:")
print(data_test)

data_test['tanı'] = np.nan
########################## özellik seçimi: tanı ile en çok ilişkili değişkenleri belirleme önemsiz olanları veriden çıkarma

korelasyon = new_data.corr()
print(korelasyon)
plt.figure(figsize=(10, 10)) 
sns.heatmap(korelasyon, annot=False, cmap='RdBu', fmt='.2f', linewidths=0.5)
plt.title('KORELASYON MATRİSİ', fontsize=16)
plt.show()

target_corr = korelasyon["tani"].abs().sort_values(ascending=False)
print("Tanı ile korelasyonu yüksek özellikler:")
print(target_corr[target_corr > 0.3])


########################## bütün değişkenlerin olduğu model
import pandas as pd
import numpy as np
from sklearn.ensemble import RandomForestClassifier
from sklearn.impute import SimpleImputer
from sklearn.metrics import accuracy_score

X_train = new_data[['YAS', 'cinsiyet', 'meslegi','sigarayibirakannekadarGUNicmis','sigarabirakangundekacadeticmis',
                    'sigarayadevamedengundekacadeticiyo','vucutagirligi','kanbasincisistolik',
                    'kanbasincidiastolik','nabiz','solunumsayisi','FEV1','FEV1%',"PEF","PEF%","FEV1/FVC_Degeri",
                    "ailedekoahveyaastimTaniliHastavarmi" ,"varsakimde_ANNE","varsakimde_BABA","varsakimde_KARDES","varsakimde_DIGER"]] 

y_train = new_data['tani'] 

X_test=data_test[['YAS', 'cinsiyet', 'meslegi','sigarayibirakannekadarGUNicmis','sigarabirakangundekacadeticmis',
                  'sigarayadevamedengundekacadeticiyo', 'vucutagirligi','kanbasincisistolik','kanbasincidiastolik'
                  ,'nabiz','solunumsayisi','FEV1','FEV1%',"PEF","PEF%","FEV1/FVC_Degeri",
                  "ailedekoahveyaastimTaniliHastavarmı" ,"varsakimde_ANNE","varsakimde_BABA","varsakimde_KARDES","varsakimde_DIGER"]] 

Y_test = data_test["tanı"]


# 3. Eksik Değerlerin İşlenmesi
# SimpleImputer kullanarak eksik değerleri doldurma
imputer = SimpleImputer(strategy='median')  # medyan ile doldurma

X_train = pd.DataFrame(imputer.fit_transform(X_train), columns=X_train.columns)
X_test = pd.DataFrame(imputer.transform(X_test), columns=X_test.columns)

# 4. Random Forest Modeli Eğitimi
model = RandomForestClassifier(random_state=42)
model.fit(X_train, y_train)

# 5. Test Verisi Üzerinde Tahmin
y_pred = model.predict(X_test)

# 6. Model Tahminlerini Yazdırma
print("Test Seti Tahminleri:")
print(y_pred)

#model doğruluğu

# Tahmin edilen değerleri new_datatest veri çerçevesindeki 'tanı' sütununa yazma
data_test['tanı'] = y_pred

# Güncellenmiş veri çerçevesini kontrol et
print(data_test.head())

############## model güvenilirliği
accuracy = accuracy_score(Y_test, y_pred)
print(f"Model doğruluğu: {accuracy:.4f}")

# 4. Özellik Önemi Görselleştirme
import matplotlib.pyplot as plt

importances = model.feature_importances_
plt.barh(X_train.columns, importances)
plt.xlabel("Feature Importance")
plt.title("Random Forest Feature Importances")
plt.show()

############################################ bütün değişkenlerin olduğu modelden, modele katkı sağlamayan değişkenler çıkarılıp yeni model kuruldu.
import pandas as pd
import numpy as np
from sklearn.ensemble import RandomForestClassifier
from sklearn.impute import SimpleImputer
from sklearn.metrics import accuracy_score


# 2. Bağımsız ve Bağımlı Değişkenleri Ayırma
X_train = new_data[[ 'YAS','cinsiyet','sigarakullanimi','sigarayibirakannekadarGUNicmis',
                    'sigarabirakangundekacadeticmis','solunumsayisi','FEV1',"PEF%"
                    ,"FEV1/FVC_Degeri"]]  # Eğitim verisi bağımsız değişkenler

y_train = new_data['tani']          # Eğitim verisi hedef değişken

X_test = data_test[[ 'YAS','cinsiyet','sigarakullanimi','sigarayibirakannekadarGUNicmis',
                 'sigarabirakangundekacadeticmis','solunumsayisi','FEV1',"PEF%",
                 "FEV1/FVC_Degeri"]]   # Test verisi bağımsız değişkenler

Y_test = data_test["tanı"]

# 3. Eksik Değerlerin İşlenmesi
# SimpleImputer kullanarak eksik değerleri doldurma
imputer = SimpleImputer(strategy='median')  # medyan ile doldurma

X_train = pd.DataFrame(imputer.fit_transform(X_train), columns=X_train.columns)
X_test = pd.DataFrame(imputer.transform(X_test), columns=X_test.columns)

# 4. Random Forest Modeli Eğitimi
model = RandomForestClassifier(random_state=42)
model.fit(X_train, y_train)

# 5. Test Verisi Üzerinde Tahmin
y_pred = model.predict(X_test)

# 6. Model Tahminlerini Yazdırma
print("Test Seti Tahminleri:")
print(y_pred)

# Tahmin edilen değerleri new_datatest veri çerçevesindeki 'tanı' sütununa yazma
data_test['tanı'] = y_pred

# Güncellenmiş veri çerçevesini kontrol et
print(data_test.head())

########### model güvenilirliği
accuracy = accuracy_score(Y_test, y_pred)
print(f"Model doğruluğu: {accuracy:.4f}")

# 4. Özellik Önemi Görselleştirme
import matplotlib.pyplot as plt

importances = model.feature_importances_
plt.barh(X_train.columns, importances)
plt.xlabel("Feature Importance")
plt.title("Random Forest Feature Importances")
plt.show()

##################### karar ağacı
from sklearn.tree import DecisionTreeClassifier, plot_tree
import matplotlib.pyplot as plt

# 1. Karar Ağacı Modeli Tanımlama
tree_model = DecisionTreeClassifier(random_state=42, max_depth=3)  # max_depth ile ağacın derinliğini sınırlandırabilirsiniz.

# 2. Modeli Eğitme
tree_model.fit(X_train, y_train)

# 3. Test Verisi Üzerinde Tahmin
y_pred_tree = tree_model.predict(X_test)
print(y_pred_tree)
# 4. Model Performansı
accuracy_tree = accuracy_score(Y_test, y_pred_tree)
print(f"Karar Ağacı Modeli Doğruluğu: {accuracy_tree:.4f}")

# 5. Karar Ağacını Görselleştirme
plt.figure(figsize=(15, 10))
plot_tree(tree_model, feature_names=X_train.columns, class_names=['0', '1'], filled=True, rounded=True)
plt.title("Karar Ağacı Görselleştirmesi")
plt.show()

################# karar ağacı mı random forest mı?

print("Karar Ağacı Doğruluk:", accuracy_score(Y_test, y_pred_tree))
print("Random Forest Doğruluk:", accuracy_score(Y_test, y_pred))

################ lojistik regresyon
from sklearn.linear_model import LogisticRegression
from sklearn.metrics import accuracy_score, classification_report, confusion_matrix
import matplotlib.pyplot as plt
import seaborn as sns

# 1. Lojistik Regresyon Modeli Tanımlama
logistic_model = LogisticRegression(random_state=42, max_iter=1000)  # max_iter artırılabilir

# 2. Modeli Eğitme
logistic_model.fit(X_train, y_train)

# 3. Test Verisi Üzerinde Tahmin
y_pred_lr = logistic_model.predict(X_test)
print(y_pred_lr)

# 4. Model Performansı (Doğruluk Skoru)
accuracy_lr = accuracy_score(Y_test, y_pred_lr)
print(f"Lojistik Regresyon Modeli Doğruluğu: {accuracy_lr:.4f}")

# 5. Performans Metrikleri (Confusion Matrix ve Classification Report)
print("\nSınıflandırma Raporu:")
print(classification_report(Y_test, y_pred_lr))

print("Karmaşıklık Matrisi:")
cm = confusion_matrix(Y_test, y_pred_lr)
sns.heatmap(cm, annot=True, fmt='d', cmap='Blues')
plt.title("Lojistik Regresyon - Karmaşıklık Matrisi")
plt.xlabel("Tahmin Edilen")
plt.ylabel("Gerçek")
plt.show()
